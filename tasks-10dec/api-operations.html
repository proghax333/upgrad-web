<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Update + Posts Pagination</title>

  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen">
  <main class="flex flex-col">
    <div class="max-w-lg mx-auto w-full">
      <form id="userUpdateForm" class="w-full p-6 mt-10 bg-white shadow-md rounded-md border">
        <h2 class="text-center font-bold text-3xl mb-6">User Update</h2>

        <div class="flex flex-col gap-2 mb-4">
          <label for="name" class="font-semibold">Name</label>
          <input type="text" name="name" id="name" class="p-2 px-4 border rounded-md" />
        </div>

        <div class="flex flex-col gap-2 mb-4">
          <label for="username" class="font-semibold">Username</label>
          <input type="text" name="username" id="username" class="p-2 px-4 border rounded-md" />
        </div>

        <div class="flex flex-col gap-2 mb-4">
          <label for="website" class="font-semibold">Website</label>
          <input type="text" name="website" id="website" class="p-2 px-4 border rounded-md" />
        </div>

        <button type="submit"
          class="p-2 px-4 w-full font-semibold text-white bg-indigo-700 rounded-md hover:bg-indigo-800">Update</button>

        <p id="statusMessage" class="text-center mt-4 font-medium"></p>
      </form>
    </div>


    <div class="max-w-lg mx-auto w-full mb-4">
      <div class="w-full p-6 mt-10 bg-white shadow-md rounded-md border">
        <h2 class="text-xl font-bold mb-4">Posts</h2>

        <div id="postsContainer" class="flex flex-col gap-4"></div>

        <div class="flex justify-between items-center mt-6">
          <button id="prevBtn" class="px-4 py-2 bg-gray-300 rounded-md disabled:opacity-40">Previous</button>

          <span id="pageIndicator" class="font-semibold"></span>

          <button id="nextBtn" class="px-4 py-2 bg-gray-300 rounded-md disabled:opacity-40">Next</button>
        </div>

      </div>
    </div>

    <div class="max-w-lg mx-auto w-full mb-4">
      <div class="w-full p-6 mt-10 bg-white shadow-md rounded-md border">
        <h2 class="text-lg font-semibold">Todo</h2>
        <div class="h-48 overflow-y-auto">
          <pre id="todo" class="mt-4"></pre>
        </div>
      </div>
    </div>
  </main>


  <script>
    const API_BASE_URL = "https://jsonplaceholder.typicode.com";
    const select = q => document.querySelector(q);

    const userUpdateFormElement = select("#userUpdateForm");
    const statusMessage = select("#statusMessage");

    const postsContainer = select("#postsContainer");
    const prevBtn = select("#prevBtn");
    const nextBtn = select("#nextBtn");
    const pageIndicator = select("#pageIndicator");

    const todo = select("#todo");

    let paginator = null;

    let user = null;

    async function getUser(id) {
      const response = await fetch(`${API_BASE_URL}/users/${id}`);
      return response.json();
    }

    async function updateUser(updatedData) {
      const response = await fetch(`${API_BASE_URL}/users/1`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(updatedData)
      });
      return response.json();
    }

    async function getPosts() {
      const response = await fetch(`${API_BASE_URL}/posts`);
      return response.json();
    }

    async function getTodo(id) {
      try {
        const response = await fetch(`${API_BASE_URL}/todos/${id}`);

        if (!response.ok) {
          throw new Error("Response was not ok.");
        }

        return response.json();
      } catch (e) {
        throw new Error(e.message || "Something went wrong!");
      }
    }

    function paginate(data, { limit }) {
      const totalItems = data.length;
      let currentPage = 1;

      const totalPages = Math.ceil(totalItems / limit);

      const hasPrevious = () => currentPage > 1;
      const hasNext = () => currentPage < totalPages;

      const next = () => { if (hasNext()) currentPage++; };
      const previous = () => { if (hasPrevious()) currentPage--; };

      const hasPage = (page) => page >= 1 && page <= totalPages;

      const goto = (page) => { if (hasPage(page)) currentPage = page; };

      const getPage = (page) => {
        const start = (page - 1) * limit;
        return data.slice(start, start + limit);
      };

      const getCurrentPage = () => getPage(currentPage);

      return {
        totalPages,
        totalItems,

        hasPrevious,
        hasNext,
        previous,
        next,
        hasPage,
        goto,

        getCurrentPage,
        getPage,

        get currentPage() {
          return currentPage;
        }
      };
    }

    function renderPosts() {
      const posts = paginator.getCurrentPage();

      postsContainer.innerHTML = posts
        .map(
          p => `
          <div class="border p-4 rounded-md shadow-sm">
            <h3 class="font-semibold text-lg">${p.title}</h3>
            <p class="text-gray-700 mt-2">${p.body}</p>
          </div>
        `
        )
        .join("");

      pageIndicator.textContent = `Page ${paginator.currentPage} of ${paginator.totalPages}`;

      prevBtn.disabled = !paginator.hasPrevious();
      nextBtn.disabled = !paginator.hasNext();
    }

    async function renderUIPosts() {
      const posts = await getPosts();
      paginator = paginate(posts, { limit: 5 });

      renderPosts();
    }

    async function loadInitialUserData() {
      try {
        user = await getUser(1);

        select("#name").value = user.name;
        select("#username").value = user.username;
        select("#website").value = user.website;

      } catch (error) {
        statusMessage.textContent = "Failed to load user data.";
        statusMessage.classList.add("text-red-600");
      }
    }

    async function renderUITodos() {
      const todoData = await getTodo(1);

      todo.innerText = JSON.stringify(todoData, null, 2);
    }

    async function handleSubmit(e) {
      e.preventDefault();

      const formData = new FormData(userUpdateFormElement);
      const updatedData = Object.fromEntries(formData.entries());
      const newData = { ...user, ...updatedData };

      try {
        const result = await updateUser(newData);

        statusMessage.textContent = "User updated successfully!";
        statusMessage.className = "text-green-600 text-center mt-4 font-semibold";

        console.log("Updated user:", result);

      } catch (error) {
        statusMessage.textContent = "Update failed!";
        statusMessage.className = "text-red-600 text-center mt-4 font-semibold";
      }
    }

    prevBtn.addEventListener("click", () => {
      paginator.previous();
      renderPosts();
    });

    nextBtn.addEventListener("click", () => {
      paginator.next();
      renderPosts();
    });

    // INIT
    loadInitialUserData();
    renderUIPosts();
    renderUITodos();

    userUpdateFormElement.addEventListener("submit", handleSubmit);
  </script>
</body>

</html>